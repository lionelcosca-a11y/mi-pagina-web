<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard: IA en Ingenier√≠a Argentina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
            color: #1c1917; /* stone-900 */
        }

        /* Chart Container Standards per Requirements */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 650px; /* Constraint width */
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        @media (min-width: 1024px) {
            .chart-container-large {
                max-width: 900px;
                height: 450px;
            }
        }

        .nav-item.active {
            background-color: #e7e5d4; /* stone-200 */
            border-left: 4px solid #0f766e; /* teal-700 */
            font-weight: 600;
        }

        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e; 
        }

        .section-hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90vw;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-stone-800">

    <!-- Modal para An√°lisis de KPI -->
    <div id="kpi-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-teal-700" id="modal-title">An√°lisis de KPI: </h3>
                <button onclick="document.getElementById('kpi-modal').classList.add('hidden')" class="text-stone-400 hover:text-stone-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="text-stone-700 space-y-4">
                <!-- Content will be injected here -->
            </div>
            <div id="modal-sources" class="mt-6 pt-4 border-t border-stone-200">
                <!-- Sources will be injected here -->
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white border-r border-stone-200 hidden md:flex flex-col z-10">
        <div class="p-6 border-b border-stone-200">
            <h1 class="text-xl font-bold text-teal-800 tracking-tight">IA en Ingenier√≠a üá¶üá∑</h1>
            <p class="text-xs text-stone-500 mt-1">Monitor de Integraci√≥n Educativa</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li>
                    <button onclick="navigate('overview')" id="nav-overview" class="nav-item active w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors text-sm font-medium flex items-center gap-2">
                        <span>üìä</span> Resumen Ejecutivo
                    </button>
                </li>
                <li>
                    <button onclick="navigate('oferta')" id="nav-oferta" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors text-sm font-medium flex items-center gap-2">
                        <span>üéì</span> Oferta Acad√©mica
                    </button>
                </li>
                <li>
                    <button onclick="navigate('docencia')" id="nav-docencia" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors text-sm font-medium flex items-center gap-2">
                        <span>üë®‚Äçüè´</span> Docencia y Capacitaci√≥n
                    </button>
                </li>
                <li>
                    <button onclick="navigate('estudiantes')" id="nav-estudiantes" class="nav-item w-full text-left px-6 py-3 hover:bg-stone-50 transition-colors text-sm font-medium flex items-center gap-2">
                        <span>üßë‚Äçüéì</span> Impacto Estudiantil
                    </button>
                </li>
            </ul>

            <!-- Gemini Query Section -->
            <div class="p-6 pt-8 border-t border-stone-200 mt-4">
                <h3 class="text-sm font-bold uppercase text-stone-600 mb-3 flex items-center gap-1">
                    ‚ú® Asistente de Consulta IA
                </h3>
                <input type="text" id="ai-query-input" placeholder="Pregunta sobre el reporte o IA..." 
                       class="w-full p-2 border border-stone-300 rounded-md text-sm mb-2 focus:ring-teal-500 focus:border-teal-500">
                <button onclick="handleGeneralQuery()" id="ai-query-button"
                        class="w-full bg-teal-600 text-white p-2 rounded-md text-sm font-semibold hover:bg-teal-700 transition-colors disabled:bg-teal-300">
                    Consultar
                </button>
                <div id="ai-query-result" class="mt-3 p-3 bg-stone-50 rounded-md text-xs border border-stone-200 hidden">
                    <p class="font-semibold text-stone-800 mb-1">Respuesta:</p>
                    <p id="ai-query-text" class="text-stone-700 italic"></p>
                    <div id="ai-query-sources" class="mt-2 pt-2 border-t border-stone-200"></div>
                </div>
            </div>
        </nav>
        <div class="p-4 border-t border-stone-200 bg-stone-50">
            <p class="text-xs text-stone-500 italic">Fuente: Reporte de Integraci√≥n IA - Universidades Argentinas</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Mobile Header -->
        <header class="md:hidden bg-white border-b border-stone-200 p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold text-teal-800">IA en Ingenier√≠a</h1>
            <button onclick="toggleMobileMenu()" class="text-stone-600 focus:outline-none text-2xl">‚ò∞</button>
        </header>

        <!-- Mobile Menu Overlay -->
        <div id="mobile-menu" class="absolute inset-0 bg-white z-50 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col p-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold">Men√∫</h2>
                <button onclick="toggleMobileMenu()" class="text-3xl">&times;</button>
            </div>
            <button onclick="navigate('overview'); toggleMobileMenu()" class="text-left py-3 text-lg border-b">Resumen Ejecutivo</button>
            <button onclick="navigate('oferta'); toggleMobileMenu()" class="text-left py-3 text-lg border-b">Oferta Acad√©mica</button>
            <button onclick="navigate('docencia'); toggleMobileMenu()" class="text-left py-3 text-lg border-b">Docencia</button>
            <button onclick="navigate('estudiantes'); toggleMobileMenu()" class="text-left py-3 text-lg border-b">Estudiantes</button>
        </div>

        <!-- Top Bar with Filters -->
        <div class="bg-white border-b border-stone-200 px-8 py-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <h2 id="page-title" class="text-2xl font-bold text-stone-800">Panorama General</h2>
                <p id="page-subtitle" class="text-sm text-stone-500">Estado de situaci√≥n de la IA en la educaci√≥n superior.</p>
            </div>
            <div class="flex items-center gap-2 bg-stone-100 p-1 rounded-lg">
                <span class="text-xs font-semibold uppercase text-stone-500 px-2">A√±o de Datos:</span>
                <select id="year-filter" onchange="updateDashboard()" class="bg-white border border-stone-300 text-stone-800 text-sm rounded-md focus:ring-teal-500 focus:border-teal-500 block p-1.5 shadow-sm">
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025 (Proyectado)</option>
                </select>
            </div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 bg-stone-50">
            
            <!-- SECTION 1: OVERVIEW (RESUMEN) -->
            <section id="view-overview" class="fade-in space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <h3 class="font-semibold text-lg text-teal-800 mb-2">Introducci√≥n</h3>
                    <p class="text-stone-600 leading-relaxed">
                        Este dashboard consolida los indicadores clave sobre la adopci√≥n de Inteligencia Artificial en las facultades de ingenier√≠a argentinas. 
                        Analiza la oferta acad√©mica formal, la preparaci√≥n del cuerpo docente y la percepci√≥n de los estudiantes, proporcionando una visi√≥n integral 
                        del salto tecnol√≥gico en instituciones como la UBA, UTN, UCA y Universidad de Palermo.
                    </p>
                </div>

                <!-- KPI Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- KPI 1 -->
                    <div class="card border-l-4 border-teal-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Crecimiento Carreras IA</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-growth">15%</h3>
                            </div>
                            <button onclick="analyzeKPI('growth')" class="text-xs font-semibold px-2 py-1 rounded bg-teal-100 text-teal-700 hover:bg-teal-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Variaci√≥n interanual oferta de grado</p>
                    </div>
                    <!-- KPI 2 -->
                    <div class="card border-l-4 border-indigo-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Capacitaci√≥n Docente</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-training">32%</h3>
                            </div>
                            <button onclick="analyzeKPI('training')" class="text-xs font-semibold px-2 py-1 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Prof. con curso IA pedag√≥gica completado</p>
                    </div>
                    <!-- KPI 3 -->
                    <div class="card border-l-4 border-orange-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Penetraci√≥n Curricular</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-hours">120 hrs</h3>
                            </div>
                            <button onclick="analyzeKPI('hours')" class="text-xs font-semibold px-2 py-1 rounded bg-orange-100 text-orange-700 hover:bg-orange-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Promedio horas c√°tedra espec√≠ficas</p>
                    </div>
                    <!-- KPI 4 -->
                    <div class="card border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Inversi√≥n Institucional</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-investment">$45M</h3>
                            </div>
                            <button onclick="analyzeKPI('investment')" class="text-xs font-semibold px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Infraestructura y licencias (estimado ARS)</p>
                    </div>
                    <!-- KPI 5 -->
                    <div class="card border-l-4 border-rose-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Brecha √âtica</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-ethics">45%</h3>
                            </div>
                            <button onclick="analyzeKPI('ethics')" class="text-xs font-semibold px-2 py-1 rounded bg-rose-100 text-rose-700 hover:bg-rose-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Estudiantes "preocupados" por impacto √©tico</p>
                    </div>
                    <!-- KPI 6 -->
                    <div class="card border-l-4 border-emerald-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-medium text-stone-500">Adopci√≥n en Aula</p>
                                <h3 class="text-3xl font-bold text-stone-800 mt-1" id="kpi-adoption">28%</h3>
                            </div>
                            <button onclick="analyzeKPI('adoption')" class="text-xs font-semibold px-2 py-1 rounded bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors">
                                ‚ú® An√°lisis
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 mt-2">Asignaturas usando IA Generativa</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Evoluci√≥n Curricular de IA</h4>
                        <p class="text-sm text-stone-500 mb-4">Promedio de horas dedicadas a IA en planes de estudio seg√∫n la rama de ingenier√≠a.</p>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Enfoque Tem√°tico</h4>
                        <p class="text-sm text-stone-500 mb-4">Distribuci√≥n del contenido en nuevos planes de estudio (Machine Learning vs √âtica vs Data Science).</p>
                        <div class="chart-container">
                            <canvas id="contentChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: ACADEMIC OFFER -->
            <section id="view-oferta" class="section-hidden fade-in space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 mb-6">
                    <h3 class="font-semibold text-lg text-teal-800 mb-2">Geograf√≠a de la Innovaci√≥n</h3>
                    <p class="text-stone-600">
                        Esta secci√≥n visualiza d√≥nde se concentran las nuevas carreras de Ingenier√≠a en Inteligencia Artificial y Ciencia de Datos (ej. UP, UdeSA, UNL).
                        El mapa destaca los polos educativos que lideran la actualizaci√≥n curricular en Argentina.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card lg:col-span-2">
                        <h4 class="font-bold text-stone-700 mb-2">Mapa de Carreras Espec√≠ficas</h4>
                        <div id="argentinaMap" class="w-full h-[400px] bg-stone-50 rounded border border-stone-200"></div>
                        <p class="text-xs text-stone-400 mt-2 text-center">Tama√±o del punto indica antig√ºedad del programa.</p>
                    </div>
                    <div class="space-y-6">
                         <div class="card bg-teal-50 border-teal-100">
                            <h4 class="font-bold text-teal-800 mb-2">Instituciones Destacadas</h4>
                            <ul class="space-y-3 text-sm text-stone-700">
                                <li class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-teal-600"></span>
                                    <strong>Univ. de Palermo:</strong> Ing. en Inteligencia Artificial
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-teal-600"></span>
                                    <strong>UdeSA:</strong> Ing. en IA (Pionera)
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-teal-600"></span>
                                    <strong>UCA:</strong> Ing. en IA y Ciencia de Datos
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-teal-600"></span>
                                    <strong>UNL:</strong> Tecnicatura e Ingenier√≠a (Santa Fe)
                                </li>
                            </ul>
                        </div>
                        <div class="card">
                            <h4 class="font-bold text-stone-700 mb-2">Tasa de Egreso Estimada</h4>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-4xl font-bold text-stone-800">65%</span>
                                <span class="text-sm text-green-600 mb-1">‚ñ≤ +5% vs Ing. Tradicional</span>
                            </div>
                            <p class="text-xs text-stone-500">Retenci√≥n en carreras de tecnolog√≠a de datos.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: TEACHING (DOCENCIA) -->
            <section id="view-docencia" class="section-hidden fade-in space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 mb-6">
                    <h3 class="font-semibold text-lg text-teal-800 mb-2">Transformaci√≥n Docente</h3>
                    <p class="text-stone-600">
                        La integraci√≥n de la IA no depende solo del plan de estudios, sino de qui√©n lo ense√±a. Aqu√≠ analizamos 
                        la capacitaci√≥n del profesorado y c√≥mo est√°n utilizando realmente estas herramientas en el aula.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Nivel de Adopci√≥n por Facultad</h4>
                        <p class="text-sm text-stone-500 mb-2">√çndice de capacitaci√≥n docente (cursos completados).</p>
                        <div class="chart-container">
                            <canvas id="facultyAdoptionChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Usos Pedag√≥gicos Comunes</h4>
                        <p class="text-sm text-stone-500 mb-2">¬øPara qu√© usan la IA los profesores?</p>
                        <div class="chart-container">
                            <canvas id="pedagogicalUseChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4 class="font-bold text-stone-700 mb-4">Barreras a la Adopci√≥n</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-rose-50 p-4 rounded border border-rose-100">
                            <h5 class="font-bold text-rose-700 text-sm uppercase">Infraestructura</h5>
                            <p class="text-2xl font-bold text-stone-800 mt-2">62%</p>
                            <p class="text-sm text-stone-600">Reportan falta de hardware adecuado (GPUs) o licencias.</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded border border-orange-100">
                            <h5 class="font-bold text-orange-700 text-sm uppercase">Tiempo</h5>
                            <p class="text-2xl font-bold text-stone-800 mt-2">48%</p>
                            <p class="text-sm text-stone-600">Falta de horas asignadas para redise√±ar materias.</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded border border-indigo-100">
                            <h5 class="font-bold text-indigo-700 text-sm uppercase">Incertidumbre √âtica</h5>
                            <p class="text-2xl font-bold text-stone-800 mt-2">35%</p>
                            <p class="text-sm text-stone-600">Dudas sobre evaluaci√≥n y plagio con IA Generativa.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 4: STUDENTS (ESTUDIANTES) -->
            <section id="view-estudiantes" class="section-hidden fade-in space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 mb-6">
                    <h3 class="font-semibold text-lg text-teal-800 mb-2">Perspectiva Estudiantil</h3>
                    <p class="text-stone-600">
                        Los estudiantes son los primeros en adoptar estas tecnolog√≠as. Esta secci√≥n mide la frecuencia de uso, 
                        el desarrollo de nuevas habilidades cr√≠ticas y c√≥mo visualizan el impacto de la IA en su futuro profesional.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Perfil de Uso de IA</h4>
                        <p class="text-sm text-stone-500 mb-2">Frecuencia y finalidad de uso por parte de estudiantes.</p>
                        <div class="chart-container">
                            <canvas id="studentUsageChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-stone-700 mb-4">Impacto en Habilidades</h4>
                        <p class="text-sm text-stone-500 mb-2">Percepci√≥n de mejora en competencias clave.</p>
                        <div class="chart-container">
                            <canvas id="skillsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4 class="font-bold text-stone-700 mb-4">Proyecci√≥n Laboral</h4>
                    <p class="text-sm text-stone-500 mb-4">¬øQu√© tan fundamental consideran la IA para su futuro trabajo?</p>
                    <div class="chart-container relative h-48 w-full">
                         <canvas id="careerProjectionChart"></canvas>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // --- CONSTANTES DEL API DE GEMINI ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const apiKey = ""; // API Key se inyecta en runtime

        // --- FUNCIONES DE UTILIDAD DEL API ---

        /**
         * Implementa la l√≥gica de reintento con retroceso exponencial.
         * @param {Function} callback La funci√≥n a ejecutar (fetch call).
         * @param {number} maxRetries El n√∫mero m√°ximo de reintentos.
         * @param {number} delay El retardo inicial en ms.
         */
        async function exponentialBackoff(callback, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await callback();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        /**
         * Llama al API de Gemini para generar contenido con b√∫squeda en Google.
         * @param {string} userQuery La pregunta del usuario.
         * @param {string} systemPrompt La instrucci√≥n del sistema para guiar el modelo.
         */
        async function fetchGeminiResponse(userQuery, systemPrompt) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const fetchCall = async () => {
                const response = await fetch(`${API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            };

            const result = await exponentialBackoff(fetchCall);

            const candidate = result.candidates?.[0];
            let text = "Lo siento, no pude generar una respuesta clara.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                text = candidate.content.parts[0].text;

                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
            }
            return { text, sources };
        }


        // --- LOGICA DE ANALISIS DE KPI (GEMINI FEATURE 1) ---

        const kpiDetails = {
            growth: { title: "Crecimiento de Carreras IA", description: "Variaci√≥n interanual de la oferta de grado con foco en IA." },
            training: { title: "Capacitaci√≥n Docente", description: "Porcentaje de profesores con cursos de IA pedag√≥gica." },
            hours: { title: "Penetraci√≥n Curricular", description: "Promedio de horas c√°tedra espec√≠ficas de IA en la malla." },
            investment: { title: "Inversi√≥n Institucional", description: "Estimado de inversi√≥n en infraestructura de IA." },
            ethics: { title: "Brecha √âtica", description: "Porcentaje de estudiantes preocupados por el impacto √©tico de la IA." },
            adoption: { title: "Adopci√≥n en Aula", description: "Porcentaje de asignaturas que utilizan IA Generativa." }
        };

        async function analyzeKPI(kpiId) {
            const detail = kpiDetails[kpiId];
            const currentValue = document.getElementById(`kpi-${kpiId}`).innerText;
            const currentYear = document.getElementById('year-filter').value;

            const modal = document.getElementById('kpi-modal');
            const titleEl = document.getElementById('modal-title');
            const bodyEl = document.getElementById('modal-body');
            const sourcesEl = document.getElementById('modal-sources');

            titleEl.innerText = `An√°lisis de KPI: ${detail.title} (${currentYear})`;
            bodyEl.innerHTML = '<div class="flex items-center space-x-2 text-teal-600"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Analizando datos y buscando contexto estrat√©gico...</p></div>';
            sourcesEl.innerHTML = '';
            modal.classList.remove('hidden');

            const systemPrompt = `Act√∫a como un consultor estrat√©gico en educaci√≥n superior y tecnolog√≠a, con enfoque en el mercado y las regulaciones argentinas. Tu tarea es analizar el KPI proporcionado a continuaci√≥n, explicar su implicancia estrat√©gica para las universidades de ingenier√≠a argentinas (como UBA, UTN, etc.), e indicar por qu√© esta m√©trica es cr√≠tica. La respuesta debe ser concisa, en un solo p√°rrafo, y fundamentada con la b√∫squeda en Google.`;
            
            const userQuery = `Analiza el KPI de "${detail.title}" que reporta un valor de ${currentValue} en ${currentYear}. ¬øCu√°l es la implicancia estrat√©gica para la Ingenier√≠a en Argentina?`;

            try {
                const { text, sources } = await fetchGeminiResponse(userQuery, systemPrompt);
                
                bodyEl.innerHTML = `<p class="leading-relaxed">${text}</p>`;
                
                if (sources.length > 0) {
                    sourcesEl.innerHTML = `<p class="text-xs font-semibold text-stone-600 mb-1">Fuentes de Fundamentaci√≥n:</p>` +
                        `<ul class="list-disc list-inside text-xs space-y-1 text-stone-500">` +
                        sources.map(s => `<li><a href="${s.uri}" target="_blank" class="hover:text-teal-600">${s.title}</a></li>`).join('') +
                        `</ul>`;
                } else {
                    sourcesEl.innerHTML = '<p class="text-xs text-stone-500 italic">An√°lisis basado en conocimiento del modelo.</p>';
                }

            } catch (e) {
                console.error("Gemini API Error:", e);
                bodyEl.innerHTML = '<p class="text-red-600">Ocurri√≥ un error al contactar al asistente de IA. Por favor, int√©ntalo de nuevo m√°s tarde.</p>';
            }
        }


        // --- LOGICA DE CONSULTA GENERAL (GEMINI FEATURE 2) ---

        async function handleGeneralQuery() {
            const input = document.getElementById('ai-query-input');
            const button = document.getElementById('ai-query-button');
            const resultBox = document.getElementById('ai-query-result');
            const resultText = document.getElementById('ai-query-text');
            const resultSources = document.getElementById('ai-query-sources');
            const query = input.value.trim();

            if (!query) {
                resultText.innerText = 'Por favor, ingresa tu consulta.';
                resultBox.classList.remove('hidden');
                return;
            }

            // UI feedback: Loading
            button.disabled = true;
            button.innerText = 'Consultando a la IA...';
            resultBox.classList.remove('hidden');
            resultText.innerHTML = '<div class="flex items-center space-x-2 text-teal-600"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-xs">Buscando y analizando...</p></div>';
            resultSources.innerHTML = '';
            
            const systemPrompt = `Act√∫a como un analista experto en la adopci√≥n de IA en la educaci√≥n superior en Am√©rica Latina, con especializaci√≥n en el contexto argentino. Responde a la pregunta del usuario de manera concisa y clara, utilizando la informaci√≥n m√°s reciente de la b√∫squeda de Google.`;

            try {
                const { text, sources } = await fetchGeminiResponse(query, systemPrompt);
                
                resultText.innerHTML = text.replace(/\n/g, '<br>');
                
                if (sources.length > 0) {
                    resultSources.innerHTML = `<p class="text-xs font-semibold text-stone-600 mb-1">Fuentes:</p>` +
                        `<ul class="list-disc list-inside text-xs space-y-1 text-stone-500">` +
                        sources.slice(0, 3).map(s => `<li><a href="${s.uri}" target="_blank" class="hover:text-teal-600">${s.title}</a></li>`).join('') +
                        `</ul>`;
                } else {
                    resultSources.innerHTML = '<p class="text-xs text-stone-500 italic">Respuesta basada en conocimiento del modelo.</p>';
                }

            } catch (e) {
                console.error("General Query API Error:", e);
                resultText.innerText = 'Ocurri√≥ un error al procesar la consulta. Intenta con una pregunta diferente.';
                resultSources.innerHTML = '';
            } finally {
                // UI feedback: Reset
                button.disabled = false;
                button.innerText = 'Consultar';
            }
        }


        // --- DASHBOARD CORE LOGIC (UNCHANGED) ---
        // Mock data representing the report content structure
        const dashboardData = {
            2023: {
                kpis: { growth: "8%", training: "15%", hours: "60 hrs", investment: "$20M", ethics: "30%", adoption: "10%" },
                evolution: [20, 35, 45], // Civil, Industrial, Systems
                content: [20, 20, 10, 50], // ML, DataSci, Ethics, Basic Coding
                faculty: [25, 40, 15, 10], // UTN, Privadas, UBA, UNLP
                usage: [60, 30, 80, 40], // Search, Explain, Code, Draft
                skills: [60, 50, 40, 70, 30] // Critical, Creative, Collab, Digital, Ethical
            },
            2024: {
                kpis: { growth: "15%", training: "32%", hours: "120 hrs", investment: "$45M", ethics: "45%", adoption: "28%" },
                evolution: [35, 55, 90],
                content: [40, 30, 15, 15], // ML, DataSci, Ethics, Robotics
                faculty: [45, 65, 30, 25],
                usage: [85, 60, 95, 70],
                skills: [75, 65, 60, 90, 55]
            },
            2025: {
                kpis: { growth: "22%", training: "55%", hours: "180 hrs", investment: "$80M", ethics: "60%", adoption: "55%" },
                evolution: [50, 80, 140],
                content: [45, 25, 20, 10],
                faculty: [65, 80, 55, 45],
                usage: [95, 80, 98, 85],
                skills: [85, 80, 75, 95, 75]
            }
        };

        let currentYear = "2024";
        let charts = {};

        function navigate(viewId) {
            document.querySelectorAll('section').forEach(el => el.classList.add('section-hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('section-hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewId}`).classList.add('active');

            const titles = {
                'overview': ['Panorama General', 'Estado de situaci√≥n de la IA en la educaci√≥n superior.'],
                'oferta': ['Oferta Acad√©mica', 'An√°lisis de nuevas carreras y planes de estudio.'],
                'docencia': ['Docencia y Capacitaci√≥n', 'Adopci√≥n de herramientas por el cuerpo docente.'],
                'estudiantes': ['Impacto Estudiantil', 'Percepci√≥n y uso de IA en el aprendizaje.']
            };
            document.getElementById('page-title').innerText = titles[viewId][0];
            document.getElementById('page-subtitle').innerText = titles[viewId][1];

            Object.values(charts).forEach(chart => chart.resize());
            if(viewId === 'oferta') Plotly.Plots.resize('argentinaMap');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu.classList.contains('translate-x-full')) {
                menu.classList.remove('translate-x-full');
            } else {
                menu.classList.add('translate-x-full');
            }
        }

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#57534e';
        
        function initDashboard() {
            renderCharts();
            renderMap();
            updateDashboard();
        }

        function renderCharts() {
            // 1. Evolution Chart (Line)
            const ctxEvo = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(ctxEvo, {
                type: 'line',
                data: {
                    labels: ['2021', '2022', '2023', '2024', '2025 (Est)'],
                    datasets: [
                        { label: 'Ing. Sistemas/Inform√°tica', data: [80, 90, 110, 150, 180], borderColor: '#0f766e', tension: 0.3 },
                        { label: 'Ing. Industrial', data: [10, 15, 25, 45, 70], borderColor: '#f97316', tension: 0.3 },
                        { label: 'Ing. Civil/Otras', data: [5, 5, 10, 20, 35], borderColor: '#64748b', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { title: { display: true, text: 'Horas C√°tedra Promedio' } } }
                }
            });

            // 2. Content Chart (Doughnut)
            const ctxContent = document.getElementById('contentChart').getContext('2d');
            charts.content = new Chart(ctxContent, {
                type: 'doughnut',
                data: {
                    labels: ['Machine Learning/DL', 'Ciencia de Datos', '√âtica y Regulaci√≥n', 'Rob√≥tica/Otros'],
                    datasets: [{
                        data: dashboardData[currentYear].content,
                        backgroundColor: ['#0d9488', '#2dd4bf', '#fb923c', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // 3. Faculty Adoption (Horizontal Bar)
            const ctxFac = document.getElementById('facultyAdoptionChart').getContext('2d');
            charts.faculty = new Chart(ctxFac, {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: ['Universidades Privadas', 'UTN', 'UBA', 'UNLP'],
                    datasets: [{
                        label: '% Docentes Capacitados',
                        data: dashboardData[currentYear].faculty,
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { max: 100 } }
                }
            });

            // 4. Pedagogical Uses (Stacked Bar)
            const ctxPed = document.getElementById('pedagogicalUseChart').getContext('2d');
            charts.pedagogical = new Chart(ctxPed, {
                type: 'bar',
                data: {
                    labels: ['Ciencias B√°sicas', 'Programaci√≥n', 'Gesti√≥n'],
                    datasets: [
                        { label: 'Generaci√≥n Material', data: [30, 20, 40], backgroundColor: '#cbd5e1' },
                        { label: 'Asistencia Codificaci√≥n', data: [10, 80, 20], backgroundColor: '#0f766e' },
                        { label: 'Evaluaci√≥n/Feedback', data: [20, 30, 25], backgroundColor: '#f97316' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, max: 100 } }
                }
            });

            // 5. Student Usage (Radar)
            const ctxUsage = document.getElementById('studentUsageChart').getContext('2d');
            charts.usage = new Chart(ctxUsage, {
                type: 'radar',
                data: {
                    labels: ['B√∫squeda Info', 'Explicaci√≥n Conceptos', 'Codificaci√≥n', 'Revisi√≥n Textos', 'Creaci√≥n Im√°genes'],
                    datasets: [{
                        label: 'Frecuencia de Uso',
                        data: dashboardData[currentYear].usage,
                        fill: true,
                        backgroundColor: 'rgba(20, 184, 166, 0.2)',
                        borderColor: '#14b8a6',
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 100, ticks: { display: false } } }
                }
            });

            // 6. Skills (Radar/Spider)
            const ctxSkills = document.getElementById('skillsChart').getContext('2d');
            charts.skills = new Chart(ctxSkills, {
                type: 'radar',
                data: {
                    labels: ['Pensamiento Cr√≠tico', 'Creatividad', 'Colaboraci√≥n', 'Alfabetizaci√≥n Digital', '√âtica'],
                    datasets: [{
                        label: 'Percepci√≥n de Mejora',
                        data: dashboardData[currentYear].skills,
                        fill: true,
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        borderColor: '#f97316',
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 100, ticks: { display: false } } }
                }
            });

            // 7. Career Projection (Bar Segmented)
            const ctxCareer = document.getElementById('careerProjectionChart').getContext('2d');
            charts.career = new Chart(ctxCareer, {
                type: 'bar',
                data: {
                    labels: ['Sistemas', 'Industrial', 'Civil', 'Electr√≥nica'],
                    datasets: [
                        { label: 'Fundamental', data: [85, 60, 30, 50], backgroundColor: '#0f766e' },
                        { label: 'Relevante', data: [15, 30, 50, 40], backgroundColor: '#94a3b8' },
                        { label: 'M√≠nimo', data: [0, 10, 20, 10], backgroundColor: '#e2e8f0' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderMap() {
            // Using Plotly Scatter Geo (simulated with manual lat/lon for cleaner look without map tokens)
            // Points: Buenos Aires, Cordoba, Santa Fe, Mendoza
            const data = [{
                type: 'scattergeo',
                mode: 'markers+text',
                text: ['Buenos Aires (UBA, UP, UCA, UdeSA, ITBA)', 'C√≥rdoba (Siglo 21)', 'Santa Fe (UNL)', 'Mendoza (U.Mendoza)'],
                lat: [-34.6037, -31.4201, -31.6107, -32.8895],
                lon: [-58.3816, -64.1888, -60.6973, -68.8458],
                marker: {
                    size: [25, 15, 15, 12],
                    color: ['#0f766e', '#f97316', '#6366f1', '#64748b'],
                    opacity: 0.8,
                    line: { width: 1, color: 'white' }
                },
                textposition: 'top center',
                hoverinfo: 'text'
            }];

            const layout = {
                geo: {
                    scope: 'south america',
                    resolution: 50,
                    showland: true,
                    landcolor: '#f5f5f4',
                    countrycolor: '#d6d3d1',
                    center: { lat: -34, lon: -64 },
                    projection: { scale: 5 } // Zoom into Argentina
                },
                margin: { l: 0, r: 0, t: 0, b: 0 },
                height: 400,
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Inter' }
            };
            
            Plotly.newPlot('argentinaMap', data, layout, {displayModeBar: false, responsive: true});
        }

        function updateDashboard() {
            const year = document.getElementById('year-filter').value;
            currentYear = year;
            const data = dashboardData[year];

            // Update KPI Text
            document.getElementById('kpi-growth').innerText = data.kpis.growth;
            document.getElementById('kpi-training').innerText = data.kpis.training;
            document.getElementById('kpi-hours').innerText = data.kpis.hours;
            document.getElementById('kpi-investment').innerText = data.kpis.investment;
            document.getElementById('kpi-ethics').innerText = data.kpis.ethics;
            document.getElementById('kpi-adoption').innerText = data.kpis.adoption;

            // Update Charts
            if(charts.content) {
                charts.content.data.datasets[0].data = data.content;
                charts.content.update();
            }
            if(charts.faculty) {
                charts.faculty.data.datasets[0].data = data.faculty;
                charts.faculty.update();
            }
            if(charts.usage) {
                charts.usage.data.datasets[0].data = data.usage;
                charts.usage.update();
            }
            if(charts.skills) {
                charts.skills.data.datasets[0].data = data.skills;
                charts.skills.update();
            }
            
            if(charts.evolution) {
                charts.evolution.update();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>
</html>